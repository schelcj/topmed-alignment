#!/usr/bin/perl

use Topmed::Base;
use Topmed::DB;

use Cache::File;

my $db    = Topmed::DB->new();
my $cache = Cache::File->new(cache_root => '/working/schelcj/cache');

while (<DATA>) {
  chomp;
  my ($id,$bamid) = split(/,/);
  my $cmd = qq{egrep -rl '^BAM_DB_ID:  $bamid\$' /working/schelcj/logs};
  chomp(my $result = capture(EXIT_ANY, $cmd));
  say "$bamid,$result";

  # my $entry = $cache->entry($bamid);
  # say "BAM: $bamid has no cache entry" unless $entry->exists();
  # my $bam_ref = $entry->thaw();

  # print Dumper $bam_ref;

  # if (exists $bam_ref->{clst}) {
  #   my $bam = $db->resultset('Bamfile')->find($bamid);
  #   $bam->mapping->update({cluster => $bam_ref->{clst}});
  #   say "Updated bam id $bamid";
  # }
}

__DATA__
id,bam_id,center_id,run_id,job_id,bam_host,status,cluster,delay
8,20,4,7,NULL,NULL,3,NULL,NULL
14,26,4,7,NULL,NULL,3,NULL,NULL
17,29,4,7,NULL,NULL,3,NULL,NULL
27,39,4,7,NULL,NULL,3,NULL,NULL
39,51,4,7,NULL,NULL,3,NULL,NULL
46,58,4,7,NULL,NULL,3,NULL,NULL
49,61,4,7,NULL,NULL,3,NULL,NULL
59,71,4,7,NULL,NULL,3,NULL,NULL
66,78,4,7,NULL,NULL,3,NULL,NULL
84,96,4,7,NULL,NULL,3,NULL,NULL
89,101,4,7,NULL,NULL,3,NULL,NULL
96,108,4,7,NULL,NULL,3,NULL,NULL
100,112,4,7,NULL,NULL,3,NULL,NULL
104,116,4,7,NULL,NULL,3,NULL,NULL
115,127,4,7,NULL,NULL,3,NULL,NULL
116,128,4,8,NULL,NULL,3,NULL,NULL
124,136,4,8,NULL,NULL,3,NULL,NULL
125,137,4,8,NULL,NULL,3,NULL,NULL
141,153,4,8,NULL,NULL,3,NULL,NULL
143,155,4,8,NULL,NULL,3,NULL,NULL
158,170,4,8,NULL,NULL,3,NULL,NULL
168,180,4,8,NULL,NULL,3,NULL,NULL
175,187,4,8,NULL,NULL,3,NULL,NULL
179,191,4,8,NULL,NULL,3,NULL,NULL
200,212,4,8,NULL,NULL,3,NULL,NULL
220,232,4,8,NULL,NULL,3,NULL,NULL
249,2218,3,17,NULL,NULL,3,NULL,NULL
258,2227,3,17,NULL,NULL,3,NULL,NULL
268,2237,3,17,NULL,NULL,3,NULL,NULL
281,2250,3,17,NULL,NULL,3,NULL,NULL
289,2258,3,17,NULL,NULL,3,NULL,NULL
297,2266,3,17,NULL,NULL,3,NULL,NULL
305,2274,3,17,NULL,NULL,3,NULL,NULL
316,2285,3,17,NULL,NULL,3,NULL,NULL
330,2299,3,17,NULL,NULL,3,NULL,NULL
333,2302,3,17,NULL,NULL,3,NULL,NULL
339,2308,3,17,NULL,NULL,3,NULL,NULL
347,2316,3,17,NULL,NULL,3,NULL,NULL
357,2326,3,17,NULL,NULL,3,NULL,NULL
374,2343,3,17,NULL,NULL,3,NULL,NULL
380,2349,3,17,NULL,NULL,3,NULL,NULL
390,2359,3,17,NULL,NULL,3,NULL,NULL
393,2362,3,17,NULL,NULL,3,NULL,NULL
407,2376,3,17,NULL,NULL,3,NULL,NULL
414,2383,3,17,NULL,NULL,3,NULL,NULL
418,2387,3,17,NULL,NULL,3,NULL,NULL
425,2394,3,17,NULL,NULL,3,NULL,NULL
431,2400,3,17,NULL,NULL,3,NULL,NULL
440,2409,3,17,NULL,NULL,3,NULL,NULL
445,2414,3,17,NULL,NULL,3,NULL,NULL
446,2415,3,17,NULL,NULL,3,NULL,NULL
450,2419,3,17,NULL,NULL,3,NULL,NULL
456,2425,3,17,NULL,NULL,3,NULL,NULL
472,2441,3,17,NULL,NULL,3,NULL,NULL
489,2458,3,17,NULL,NULL,3,NULL,NULL
491,2460,3,17,NULL,NULL,3,NULL,NULL
498,2467,3,17,NULL,NULL,3,NULL,NULL
507,2476,3,17,NULL,NULL,3,NULL,NULL
510,2479,3,17,NULL,NULL,3,NULL,NULL
513,2482,3,17,NULL,NULL,3,NULL,NULL
538,2507,3,17,NULL,NULL,3,NULL,NULL
541,2510,3,17,NULL,NULL,3,NULL,NULL
549,2518,3,17,NULL,NULL,3,NULL,NULL
553,2522,3,17,NULL,NULL,3,NULL,NULL
596,2565,3,17,NULL,NULL,3,NULL,NULL
607,2576,3,17,NULL,NULL,3,NULL,NULL
614,2583,3,17,NULL,NULL,3,NULL,NULL
620,2589,3,17,NULL,NULL,3,NULL,NULL
621,2590,3,17,NULL,NULL,3,NULL,NULL
639,2608,3,17,NULL,NULL,3,NULL,NULL
645,2614,3,17,NULL,NULL,3,NULL,NULL
657,2626,3,17,NULL,NULL,3,NULL,NULL
665,2634,3,17,NULL,NULL,3,NULL,NULL
681,2650,3,17,NULL,NULL,3,NULL,NULL
685,2654,3,17,NULL,NULL,3,NULL,NULL
707,2676,3,17,NULL,NULL,3,NULL,NULL
717,2686,3,17,NULL,NULL,3,NULL,NULL
721,2690,3,17,NULL,NULL,3,NULL,NULL
730,2699,3,17,NULL,NULL,3,NULL,NULL
736,2705,2,18,NULL,NULL,3,NULL,NULL
743,2712,2,18,NULL,NULL,3,NULL,NULL
758,2727,2,18,NULL,NULL,3,NULL,NULL
764,2733,2,18,NULL,NULL,3,NULL,NULL
794,2763,2,18,NULL,NULL,3,NULL,NULL
827,2796,2,18,NULL,NULL,3,NULL,NULL
946,2915,2,18,NULL,NULL,3,NULL,NULL
963,2932,2,19,NULL,NULL,3,NULL,NULL
975,2944,2,19,NULL,NULL,3,NULL,NULL
1020,2989,2,19,NULL,NULL,3,NULL,NULL
1025,2994,2,19,NULL,NULL,3,NULL,NULL
1035,3004,2,19,NULL,NULL,3,NULL,NULL
1056,3025,2,19,NULL,NULL,3,NULL,NULL
1105,3074,2,19,NULL,NULL,3,NULL,NULL
1120,3089,2,19,NULL,NULL,3,NULL,NULL
1145,3114,2,19,NULL,NULL,3,NULL,NULL
1175,3144,4,9,NULL,NULL,3,NULL,NULL
1180,3149,4,9,NULL,NULL,3,NULL,NULL
1188,3157,4,9,NULL,NULL,3,NULL,NULL
1194,3163,4,9,NULL,NULL,3,NULL,NULL
1211,3180,4,9,NULL,NULL,3,NULL,NULL
1216,3185,4,9,NULL,NULL,3,NULL,NULL
1231,3200,4,9,NULL,NULL,3,NULL,NULL
1236,3205,4,9,NULL,NULL,3,NULL,NULL
1242,3211,4,9,NULL,NULL,3,NULL,NULL
1248,3217,4,9,NULL,NULL,3,NULL,NULL
1249,3218,4,9,NULL,NULL,3,NULL,NULL
1265,3234,4,9,NULL,NULL,3,NULL,NULL
1269,3238,4,9,NULL,NULL,3,NULL,NULL
1270,3239,4,10,NULL,NULL,3,NULL,NULL
1272,3241,4,10,NULL,NULL,3,NULL,NULL
1282,3251,4,10,NULL,NULL,3,NULL,NULL
1287,3256,4,10,NULL,NULL,3,NULL,NULL
1291,3260,4,10,NULL,NULL,3,NULL,NULL
1305,3274,4,10,NULL,NULL,3,NULL,NULL
1317,3286,4,10,NULL,NULL,3,NULL,NULL
1318,3287,4,10,NULL,NULL,3,NULL,NULL
1333,3302,4,10,NULL,NULL,3,NULL,NULL
1342,3311,4,10,NULL,NULL,3,NULL,NULL
1357,3326,4,10,NULL,NULL,3,NULL,NULL
1374,3343,4,11,NULL,NULL,3,NULL,NULL
1395,3364,4,11,NULL,NULL,3,NULL,NULL
1400,3369,4,11,NULL,NULL,3,NULL,NULL
1403,3372,4,11,NULL,NULL,3,NULL,NULL
1415,3384,4,11,NULL,NULL,3,NULL,NULL
1428,3397,4,11,NULL,NULL,3,NULL,NULL
1437,3406,4,11,NULL,NULL,3,NULL,NULL
1444,3413,4,11,NULL,NULL,3,NULL,NULL
1447,3416,4,11,NULL,NULL,3,NULL,NULL
1450,3419,4,11,NULL,NULL,3,NULL,NULL
1452,3421,4,11,NULL,NULL,3,NULL,NULL
1462,3431,4,11,NULL,NULL,3,NULL,NULL
1477,3446,4,12,NULL,NULL,3,NULL,NULL
1498,3467,4,12,NULL,NULL,3,NULL,NULL
1506,3475,4,12,NULL,NULL,3,NULL,NULL
1516,3485,4,12,NULL,NULL,3,NULL,NULL
1528,3497,4,12,NULL,NULL,3,NULL,NULL
1537,3506,4,12,NULL,NULL,3,NULL,NULL
1540,3509,4,12,NULL,NULL,3,NULL,NULL
1549,3518,4,12,NULL,NULL,3,NULL,NULL
1552,3521,4,12,NULL,NULL,3,NULL,NULL
1558,3527,4,12,NULL,NULL,3,NULL,NULL
1567,3536,4,12,NULL,NULL,3,NULL,NULL
1571,3540,2,18,NULL,NULL,3,NULL,NULL
1590,3559,2,18,NULL,NULL,3,NULL,NULL
1605,3574,2,18,NULL,NULL,3,NULL,NULL
1619,3588,2,18,NULL,NULL,3,NULL,NULL
1627,3596,2,18,NULL,NULL,3,NULL,NULL
1643,3612,2,18,NULL,NULL,3,NULL,NULL
1669,3638,2,19,NULL,NULL,3,NULL,NULL
1707,3676,4,29,NULL,NULL,3,NULL,NULL
1714,3683,4,29,NULL,NULL,3,NULL,NULL
1723,3692,4,29,NULL,NULL,3,NULL,NULL
1725,3694,4,29,NULL,NULL,3,NULL,NULL
1738,3707,4,29,NULL,NULL,3,NULL,NULL
1757,3726,4,30,NULL,NULL,3,NULL,NULL
1758,3727,4,30,NULL,NULL,3,NULL,NULL
1774,3743,4,30,NULL,NULL,3,NULL,NULL
1781,3750,4,30,NULL,NULL,3,NULL,NULL
1802,3771,4,30,NULL,NULL,3,NULL,NULL
1818,3787,4,30,NULL,NULL,3,NULL,NULL
1825,3794,4,30,NULL,NULL,3,NULL,NULL
1833,3802,4,30,NULL,NULL,3,NULL,NULL
1855,3824,4,30,NULL,NULL,3,NULL,NULL
1860,3829,4,29,NULL,NULL,3,NULL,NULL
1867,3836,4,29,NULL,NULL,3,NULL,NULL
1875,3844,4,29,NULL,NULL,3,NULL,NULL
1880,3849,4,29,NULL,NULL,3,NULL,NULL
1882,3851,4,29,NULL,NULL,3,NULL,NULL
1893,3862,4,29,NULL,NULL,3,NULL,NULL
1910,3879,1,20,NULL,NULL,3,NULL,NULL
1915,3884,1,20,NULL,NULL,3,NULL,NULL
1920,3889,1,20,NULL,NULL,3,NULL,NULL
1937,3906,1,20,NULL,NULL,3,NULL,NULL
1945,3914,1,20,NULL,NULL,3,NULL,NULL
1950,3919,1,20,NULL,NULL,3,NULL,NULL
1959,3928,1,20,NULL,NULL,3,NULL,NULL
1967,3936,1,20,NULL,NULL,3,NULL,NULL
1970,3939,1,20,NULL,NULL,3,NULL,NULL
1975,3944,1,20,NULL,NULL,3,NULL,NULL
1988,3957,1,20,NULL,NULL,3,NULL,NULL
2001,3970,1,20,NULL,NULL,3,NULL,NULL
2032,4001,1,20,NULL,NULL,3,NULL,NULL
2043,4012,1,20,NULL,NULL,3,NULL,NULL
2049,4018,1,20,NULL,NULL,3,NULL,NULL
2050,4019,1,20,NULL,NULL,3,NULL,NULL
2056,4025,1,20,NULL,NULL,3,NULL,NULL
2067,4036,1,20,NULL,NULL,3,NULL,NULL
2077,4046,1,20,NULL,NULL,3,NULL,NULL
2090,4059,1,20,NULL,NULL,3,NULL,NULL
2091,4060,1,20,NULL,NULL,3,NULL,NULL
2097,4066,1,20,NULL,NULL,3,NULL,NULL
2098,4067,1,20,NULL,NULL,3,NULL,NULL
2117,4086,1,20,NULL,NULL,3,NULL,NULL
2118,4087,1,20,NULL,NULL,3,NULL,NULL
2128,4097,1,20,NULL,NULL,3,NULL,NULL
2140,4109,1,20,NULL,NULL,3,NULL,NULL
2144,4113,1,20,NULL,NULL,3,NULL,NULL
2146,4115,1,20,NULL,NULL,3,NULL,NULL
2168,4137,1,20,NULL,NULL,3,NULL,NULL
2175,4144,1,20,NULL,NULL,3,NULL,NULL
2202,4171,1,20,NULL,NULL,3,NULL,NULL
2211,4180,1,20,NULL,NULL,3,NULL,NULL
2215,4184,1,20,NULL,NULL,3,NULL,NULL
2220,4189,1,20,NULL,NULL,3,NULL,NULL
2229,4198,1,20,NULL,NULL,3,NULL,NULL
2231,4200,1,20,NULL,NULL,3,NULL,NULL
2240,4209,1,20,NULL,NULL,3,NULL,NULL
2244,4213,1,20,NULL,NULL,3,NULL,NULL
2249,4218,1,20,NULL,NULL,3,NULL,NULL
2266,4235,1,20,NULL,NULL,3,NULL,NULL
2274,4243,1,20,NULL,NULL,3,NULL,NULL
2289,4258,1,20,NULL,NULL,3,NULL,NULL
2292,4261,1,20,NULL,NULL,3,NULL,NULL
2300,4269,1,20,NULL,NULL,3,NULL,NULL
2303,4272,1,20,NULL,NULL,3,NULL,NULL
2324,4293,1,20,NULL,NULL,3,NULL,NULL
2335,4304,1,20,NULL,NULL,3,NULL,NULL
2350,4319,1,20,NULL,NULL,3,NULL,NULL
2354,4323,1,20,NULL,NULL,3,NULL,NULL
2366,4335,1,20,NULL,NULL,3,NULL,NULL
2371,4340,1,20,NULL,NULL,3,NULL,NULL
2374,4343,1,20,NULL,NULL,3,NULL,NULL
2384,4353,1,20,NULL,NULL,3,NULL,NULL
2389,4358,1,20,NULL,NULL,3,NULL,NULL
2392,4361,1,20,NULL,NULL,3,NULL,NULL
2393,4362,1,20,NULL,NULL,3,NULL,NULL
2407,4376,1,20,NULL,NULL,3,NULL,NULL
2421,4390,1,20,NULL,NULL,3,NULL,NULL
2428,4397,1,20,NULL,NULL,3,NULL,NULL
2432,4401,1,20,NULL,NULL,3,NULL,NULL
2436,4405,1,20,NULL,NULL,3,NULL,NULL
2447,4416,1,20,NULL,NULL,3,NULL,NULL
2453,4422,1,20,NULL,NULL,3,NULL,NULL
2454,4423,1,20,NULL,NULL,3,NULL,NULL
2460,4429,1,20,NULL,NULL,3,NULL,NULL
2476,4445,1,20,NULL,NULL,3,NULL,NULL
2478,4447,1,20,NULL,NULL,3,NULL,NULL
2505,4474,1,20,NULL,NULL,3,NULL,NULL
2506,4475,1,20,NULL,NULL,3,NULL,NULL
2535,4504,4,33,NULL,NULL,3,NULL,NULL
2537,4506,4,34,NULL,NULL,3,NULL,NULL
2546,4515,4,34,NULL,NULL,3,NULL,NULL
2568,4537,4,34,NULL,NULL,3,NULL,NULL
2583,4552,4,33,NULL,NULL,3,NULL,NULL
2598,4567,4,34,NULL,NULL,3,NULL,NULL
2601,4570,4,32,NULL,NULL,3,NULL,NULL
2613,4582,4,34,NULL,NULL,3,NULL,NULL
2618,4587,4,32,NULL,NULL,3,NULL,NULL
2622,4591,4,33,NULL,NULL,3,NULL,NULL
2626,4595,4,34,NULL,NULL,3,NULL,NULL
2635,4604,4,33,NULL,NULL,3,NULL,NULL
2644,4613,4,32,NULL,NULL,3,NULL,NULL
2656,4625,4,33,NULL,NULL,3,NULL,NULL
2659,4628,4,33,NULL,NULL,3,NULL,NULL
2680,4649,4,32,NULL,NULL,3,NULL,NULL
2688,4657,4,33,NULL,NULL,3,NULL,NULL
2692,4661,4,34,NULL,NULL,3,NULL,NULL
2702,4671,4,33,NULL,NULL,3,NULL,NULL
2707,4676,4,33,NULL,NULL,3,NULL,NULL
2717,4686,4,34,NULL,NULL,3,NULL,NULL
2735,4704,4,33,NULL,NULL,3,NULL,NULL
2740,4709,4,34,NULL,NULL,3,NULL,NULL
2795,4764,4,33,NULL,NULL,3,NULL,NULL
2801,4770,4,34,NULL,NULL,3,NULL,NULL
2803,4772,4,32,NULL,NULL,3,NULL,NULL
2815,4784,2,21,NULL,NULL,3,NULL,NULL
2828,4797,2,21,NULL,NULL,3,NULL,NULL
2904,4873,2,21,NULL,NULL,3,NULL,NULL
2918,4887,2,21,NULL,NULL,3,NULL,NULL
2933,4902,4,34,NULL,NULL,3,NULL,NULL
2961,4930,2,35,NULL,NULL,3,NULL,NULL
2969,4938,2,35,NULL,NULL,3,NULL,NULL
2980,4949,2,35,NULL,NULL,3,NULL,NULL
2984,4953,2,35,NULL,NULL,3,NULL,NULL
2994,4963,2,35,NULL,NULL,3,NULL,NULL
3026,4995,2,35,NULL,NULL,3,NULL,NULL
3037,5006,2,35,NULL,NULL,3,NULL,NULL
3090,5059,2,35,NULL,NULL,3,NULL,NULL
3115,5084,2,35,NULL,NULL,3,NULL,NULL
3124,5093,2,35,NULL,NULL,3,NULL,NULL
3139,5108,2,35,NULL,NULL,3,NULL,NULL
3196,5165,2,35,NULL,NULL,3,NULL,NULL
3246,5215,1,41,NULL,NULL,3,NULL,NULL
3248,5217,1,41,NULL,NULL,3,NULL,NULL
3269,5238,1,41,NULL,NULL,3,NULL,NULL
3294,5263,1,41,NULL,NULL,3,NULL,NULL
3323,5292,1,41,NULL,NULL,3,NULL,NULL
3340,5309,1,41,NULL,NULL,3,NULL,NULL
3341,5310,1,41,NULL,NULL,3,NULL,NULL
3355,5324,1,41,NULL,NULL,3,NULL,NULL
3368,5337,1,41,NULL,NULL,3,NULL,NULL
3376,5345,1,41,NULL,NULL,3,NULL,NULL
3380,5349,1,41,NULL,NULL,3,NULL,NULL
3389,5358,1,41,NULL,NULL,3,NULL,NULL
3396,5365,1,41,NULL,NULL,3,NULL,NULL
3437,5406,1,41,NULL,NULL,3,NULL,NULL
3447,5416,1,41,NULL,NULL,3,NULL,NULL
3474,5443,1,41,NULL,NULL,3,NULL,NULL
3488,5457,1,41,NULL,NULL,3,NULL,NULL
3495,5464,1,41,NULL,NULL,3,NULL,NULL
3506,5475,1,41,NULL,NULL,3,NULL,NULL
3530,5499,1,41,NULL,NULL,3,NULL,NULL
3534,5503,1,41,NULL,NULL,3,NULL,NULL
3539,5508,1,41,NULL,NULL,3,NULL,NULL
3562,5531,1,41,NULL,NULL,3,NULL,NULL
3567,5536,1,41,NULL,NULL,3,NULL,NULL
3572,5541,1,41,NULL,NULL,3,NULL,NULL
3575,5544,1,41,NULL,NULL,3,NULL,NULL
3629,5598,4,42,NULL,NULL,3,NULL,NULL
3641,5610,4,43,NULL,NULL,3,NULL,NULL
3652,5621,4,43,NULL,NULL,3,NULL,NULL
3699,5668,4,43,NULL,NULL,3,NULL,NULL
3702,5671,4,42,NULL,NULL,3,NULL,NULL
3706,5675,4,42,NULL,NULL,3,NULL,NULL
3718,5687,4,42,NULL,NULL,3,NULL,NULL
3744,5713,4,43,NULL,NULL,3,NULL,NULL
3773,5742,4,42,NULL,NULL,3,NULL,NULL
3776,5745,4,42,NULL,NULL,3,NULL,NULL
3783,5752,4,43,NULL,NULL,3,NULL,NULL
3790,5759,4,42,NULL,NULL,3,NULL,NULL
3791,5760,4,42,NULL,NULL,3,NULL,NULL
3798,5767,4,43,NULL,NULL,3,NULL,NULL
3801,5770,4,43,NULL,NULL,3,NULL,NULL
3805,5774,4,42,NULL,NULL,3,NULL,NULL
3811,5780,4,42,NULL,NULL,3,NULL,NULL
5482,7753,1,53,0,NULL,1440136195,NULL,NULL
5506,7777,1,53,0,NULL,1440108529,NULL,NULL
5648,7919,1,53,0,NULL,1440155265,NULL,NULL
